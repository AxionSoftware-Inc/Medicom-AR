<!DOCTYPE html>
<html>
<head>
    <title>3DoF Navigatsiya</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        /* Start tugmasi uchun Overlay (Majburiy) */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        #btnStart {
            padding: 15px 30px; font-size: 20px; background: #00d2ff;
            border: none; border-radius: 10px; color: white; font-weight: bold;
        }
        #navHintText {
            position: fixed; top: 20px; width: 100%; text-align: center;
            color: yellow; font-size: 24px; z-index: 10; font-family: sans-serif;
            text-shadow: 2px 2px 4px #000; display: none;
        }
    </style>
</head>
<body>

    <div id="overlay">
        <h2 style="color:white; margin-bottom:20px;">Navigatsiyani boshlash</h2>
        <button id="btnStart">BOSHLASH</button>
    </div>

    <div id="navHintText"></div>

    <a-scene embedded vr-mode-ui="enabled: false">
        <a-entity id="cameraRig">
            <a-camera position="0 1.6 0" look-controls="enabled: true"></a-camera>
        </a-entity>
        
        <a-entity id="worldRoot"></a-entity>
    </a-scene>

    <script>
        // --- 1. MA'LUMOTLAR BAZASI (JSON) ---
        const floorsData = {
            "1": [
                { "id": "101", "x": 6, "side": "left", "width": 1.5, "corridorDir": "left" },
                { "id": "102", "x": 8, "side": "left", "width": 1.5, "corridorDir": "left" },
                { "id": "103", "x": 10, "side": "right", "width": 1.5, "corridorDir": "left" } // Misol
            ]
        };

        // --- 2. O'ZGARUVCHILAR ---
        // Misol uchun URL dan ?room=101 deb olamiz yoki shu yerda ruchnoy yozamiz
        const targetRoomId = "101"; 
        const currentFloor = "1";
        const worldRoot = document.getElementById('worldRoot');
        const navHintText = document.getElementById('navHintText');
        const overlay = document.getElementById('overlay');
        const btnStart = document.getElementById('btnStart');

        // --- 3. XONANI QIDIRIB TOPISH ---
        function findRoomData(floor, id) {
            const rooms = floorsData[floor];
            if (!rooms) return null;
            return rooms.find(r => r.id === id);
        }

        // --- 4. START TUGMASI VA SENSOR RUXSATI ---
        btnStart.addEventListener('click', function() {
            // iOS 13+ uchun ruxsat so'rash
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            initNavigation();
                        } else {
                            alert("Datchiklarga ruxsat berilmadi!");
                        }
                    })
                    .catch(console.error);
            } else {
                // Android va boshqalar
                initNavigation();
            }
        });

        function initNavigation() {
            // Overlayni yo'qotamiz
            overlay.style.display = 'none';
            navHintText.style.display = 'block';

            // Xonani topamiz
            const room = findRoomData(currentFloor, targetRoomId);
            
            if (room) {
                draw3DoFPath(room);
            } else {
                navHintText.innerText = "Xona topilmadi!";
                navHintText.style.color = "red";
            }
        }

        // --- 5. CHIZISH FUNKSIYASI (Sizning kodingiz asosida) ---
        function draw3DoFPath(room) {
            worldRoot.innerHTML = ''; // Tozalash

            const isLeft = (room.corridorDir === 'left'); // JSON dagi "corridorDir" ga qaraymiz
            const dirX = isLeft ? -1 : 1;
            
            // Maslahat matni
            const turnText = isLeft ? "CHAPGA" : "O'NGGA";
            navHintText.innerText = `${turnText} BURILING VA STRELKALARGA QARANG`;

            // A. STRELKALAR (Harakatlanuvchi)
            const distance = room.x;
            
            for (let i = 1.0; i < distance; i += 1.5) {
                const arrowGroup = document.createElement('a-entity');
                
                // Position: X o'qi bo'yicha joylashadi
                // User 0,0,0 da turibdi. Strelkalar yon tomondan chiqadi.
                arrowGroup.setAttribute('position', `${i * dirX} -0.8 0`);

                // Animatsiya: Oqish effekti
                arrowGroup.setAttribute('animation', `
                    property: position; 
                    to: ${(i * dirX) + (1.5 * dirX)} -0.8 0; 
                    dur: 1500; 
                    easing: linear; 
                    loop: true
                `);

                const arrow = document.createElement('a-entity');
                arrow.setAttribute('geometry', 'primitive: triangle; vertexA: 0 0 0; vertexB: -0.2 0 0.3; vertexC: 0.2 0 0.3');
                arrow.setAttribute('material', 'color: #00d2ff; shader: flat; transparent: true; opacity: 0.8; side: double');
                
                // Burilish: Strelka qaysi tomonga ketayotganini ko'rsatish
                // Agar Left Corridor bo'lsa, strelka Chapga (-X) qarashi kerak -> Y=90
                // Agar Right Corridor bo'lsa, strelka O'ngga (+X) qarashi kerak -> Y=-90
                const rotY = isLeft ? 90 : -90;
                
                // Strelkani yerga yotqizish (-90 X) va yo'nalishga burish
                arrow.setAttribute('rotation', `-90 ${rotY} 0`);

                arrowGroup.appendChild(arrow);
                worldRoot.appendChild(arrowGroup);
            }

            // B. FINISH (Eshik va Xona raqami)
            const destGroup = document.createElement('a-entity');
            
            // Z koordinata (Eshik devorda):
            // Agar koridor Chapda (-X) bo'lsa:
            //   - Xona chapda (side:left) -> Eshik +Z da
            //   - Xona o'ngda (side:right) -> Eshik -Z da
            let doorZ = 0;
            if (isLeft) {
                 doorZ = (room.side === 'left') ? 1.5 : -1.5;
            } else {
                 doorZ = (room.side === 'left') ? -1.5 : 1.5;
            }

            // Finish nuqtasi (Faqat ko'rish uchun, user bormaydi)
            destGroup.setAttribute('position', `${distance * dirX} -0.5 ${doorZ}`);

            // 1. Oq Strelka (Pastga qaragan)
            const finishArrow = document.createElement('a-entity');
            finishArrow.setAttribute('geometry', 'primitive: triangle; vertexA: 0 0.4 0; vertexB: -0.3 -0.4 0; vertexC: 0.3 -0.4 0');
            finishArrow.setAttribute('material', 'color: white; shader: flat; side: double');
            finishArrow.setAttribute('position', '0 1 0');
            
            // Sakrash animatsiyasi
            finishArrow.setAttribute('animation', 'property: position; from: 0 1 0; to: 0 1.2 0; dir: alternate; loop: true; dur: 800');

            // 2. Matn (Xona raqami)
            const text = document.createElement('a-text');
            text.setAttribute('value', `Xona ${room.id}`);
            text.setAttribute('align', 'center');
            text.setAttribute('scale', '6 6 6');
            text.setAttribute('position', '0 1.8 0');
            text.setAttribute('color', 'white');

            // --- USERGA QARATISH (Muhim qismi) ---
            // Finish nuqtasi uzoqda. Matn va strelka userga (0,0,0) qarab turishi kerak.
            // Agar biz Chap koridorda (-X) bo'lsak, user O'ng tomonda qoladi -> Y=-90 burish kerak (taxminan)
            // Lekin eng aniq yo'li: look-at komponenti yoki oddiy logika:
            
            let facingUserY = isLeft ? -90 : 90; // User tomonga burish
            
            // Strelka va Matnni buramiz
            finishArrow.setAttribute('rotation', `0 ${facingUserY} 180`); // 180 bu uchi pastga qarashi uchun
            text.setAttribute('rotation', `0 ${facingUserY} 0`);

            destGroup.appendChild(finishArrow);
            destGroup.appendChild(text);
            worldRoot.appendChild(destGroup);
        }
    </script>
</body>
</html>